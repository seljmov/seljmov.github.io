<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сборы</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="wrapper">
        <img src="img/tooba_logo.png" alt="logo" class="logo">
        <div id="loading" style="display: flex; align-items: center; justify-content: center;">
            <span>Загрузка...</span>
        </div>
        <div id="main-list" class="campaigns-list">
            <div class="campaign-main-card"></div>
            <button id="show-more" class="login-button" style="width: max-content; padding-left: 16px; padding-right: 16px;">
                Показать больше
            </button>
            <div class="campaign-sublist"></div>
        </div>
    </div>

    <script>
        let user_id = undefined;
        function getQueryParam(paramName) {
            const url = new URL(window.location.href);
            const params = new URLSearchParams(url.search);
            return params.get(paramName);
        }

        const generateCampaignCard = (campaign) => {
            const campaignCard = document.createElement('div');
            campaignCard.classList.add('campaign-card');

            const campaignTitle = document.createElement('h3');
            campaignTitle.classList.add('campaign-title');
            campaignTitle.textContent = campaign.title + ' (' + campaign.id + ')';

            const campaignInfo = document.createElement('div');
            campaignInfo.classList.add('campaign-info');

            const campaignAmount = document.createElement('div');
            campaignAmount.classList.add('campaign-amount');

            const campaignAmountGoal = document.createElement('div');
            campaignAmountGoal.classList.add('campaign-amount-goal');

            const campaignAmountGoalTitle = document.createElement('p');
            campaignAmountGoalTitle.classList.add('campaign-amount-goal-title');
            campaignAmountGoalTitle.textContent = 'Нужно';

            const campaignAmountGoalValue = document.createElement('span');
            campaignAmountGoalValue.classList.add('campaign-amount-goal-value');
            campaignAmountGoalValue.textContent = `${campaign.goal} ₽`;

            campaignAmountGoal.appendChild(campaignAmountGoalTitle);
            campaignAmountGoal.appendChild(campaignAmountGoalValue);

            const campaignAmountCollected = document.createElement('div');
            campaignAmountCollected.classList.add('campaign-amount-collected');

            const campaignAmountCollectedTitle = document.createElement('p');
            campaignAmountCollectedTitle.classList.add('campaign-amount-collected-title');
            campaignAmountCollectedTitle.textContent = 'Собрали';

            const campaignAmountCollectedValue = document.createElement('span');
            campaignAmountCollectedValue.classList.add('campaign-amount-collected-value');
            campaignAmountCollectedValue.textContent = `${campaign.collected} ₽`;

            campaignAmountCollected.appendChild(campaignAmountCollectedTitle);
            campaignAmountCollected.appendChild(campaignAmountCollectedValue);

            campaignAmount.appendChild(campaignAmountGoal);
            campaignAmount.appendChild(campaignAmountCollected);

            const campaignActions = document.createElement('div');
            campaignActions.classList.add('campaign-actions');

            const campaignShare = document.createElement('button');
            campaignShare.classList.add('campaign-share');
            campaignShare.textContent = 'Поделиться';

            const campaignHelp = document.createElement('button');
            campaignHelp.classList.add('campaign-help');
            campaignHelp.textContent = 'Помочь';

            campaignActions.appendChild(campaignShare);
            campaignActions.appendChild(campaignHelp);

            campaignInfo.appendChild(campaignAmount);
            campaignInfo.appendChild(campaignActions);

            campaignCard.appendChild(campaignTitle);
            campaignCard.appendChild(campaignInfo);

            return campaignCard;
        }

        async function findUserIdByNumber(filePath, number) {
            try {
                const response = await fetch(filePath);
                
                if (!response.ok) {
                    throw new Error('Ошибка загрузки файла: ' + response.statusText);
                }

                const data = await response.json();

                // Находим соответствующий ключ (user_id) по значению (число)
                for (const [userId, value] of Object.entries(data)) {
                    if (value == number) {
                        return userId;
                    }
                }

                console.log("Пользователь с таким числом не найден.");
                return null;

            } catch (error) {
                console.error("Произошла ошибка:", error);
                return null;
            }
        }

        async function getCampaignsIds(filePath) {
            try {
                const response = await fetch(filePath);

                if (!response.ok) {
                    throw new Error('Ошибка загрузки файла: ' + response.statusText);
                }

                const data = await response.json();

                return Array.from(data["Query result"]).map(campaign => campaign.id);
            } catch (error) {
                console.error("Произошла ошибка:", error);
                return [];
            }
        }

        async function findCampaignWithMostKeywords(campaigns) {
            if (Object.keys(campaigns).length === 0) {
                return Promise.resolve({}); // Возвращаем промис с пустым объектом
            }

            try {
                const campaignsIds = await getCampaignsIds('data/campaigns.json');
                const campaignsIdsArray = Array.from(campaignsIds);

                const filteredCampaignsIds = Object.keys(campaigns).filter(campaignId => campaignsIdsArray.includes(parseInt(campaignId)));
                const filteredCampaigns = Object.fromEntries(filteredCampaignsIds.map(campaignId => [campaignId, campaigns[parseInt(campaignId)]]));

                // Находим максимальное количество ключевых слов
                const maxKeywordsCount = Math.max(...Object.values(filteredCampaigns).map(keywords => keywords.length));

                // Находим все кампании с максимальным количеством ключевых слов
                const topCampaigns = Object.entries(filteredCampaigns)
                    .filter(([_, keywords]) => keywords.length === maxKeywordsCount)
                    .map(([campaignId, keywords]) => ({
                        campaign_id: campaignId,
                        keywords_count: keywords.length,
                        keywords: keywords
                    }));

                let max = topCampaigns[0].keywords_count;
                if (topCampaigns.length < 16) {
                    while (max > 0 && topCampaigns.length < 16) {
                        const topCampaignsMax = Object.entries(filteredCampaigns)
                            .filter(([_, keywords]) => keywords.length === max)
                            .map(([campaignId, keywords]) => ({
                                campaign_id: campaignId,
                                keywords_count: keywords.length,
                                keywords: keywords
                            }));
                        topCampaigns.push(...topCampaignsMax);
                        max--;
                    }
                }

                return topCampaigns;
            } catch (error) {
                console.error("Произошла ошибка:", error);
                return [];
            }
        }

        async function getCampaignsByKeywords(filePath, predictionArray) {
            try {
                const response = await fetch(filePath);

                if (!response.ok) {
                    throw new Error('Ошибка загрузки файла: ' + response.statusText);
                }

                const data = await response.json();
                const campaigns = {};

                // Пройдём по каждому ключевому слову из предсказания
                predictionArray.forEach(keyword => {
                    // Найдём кампании, в которых встречается это ключевое слово
                    const keywordCampaigns = Array.from(data["Query result"]).filter(campaign => campaign.keyword_id == keyword);

                    // Добавим кампании в объект
                    keywordCampaigns.forEach(campaign => {
                        campaign.id = campaign.campaign_id;
                        if (campaigns[campaign.id]) {
                            campaigns[campaign.id].push(keyword);
                        } else {
                            campaigns[campaign.id] = [keyword];
                        }
                    });
                });

                return campaigns;
            } catch (error) {
                console.error("Произошла ошибка:", error);
                return {};
            }
        }

        async function getCampaignsDetails(filePath, campaignIds) {
            try {
                const response = await fetch(filePath);

                if (!response.ok) {
                    throw new Error('Ошибка загрузки файла: ' + response.statusText);
                }

                const data = await response.json();
                const campaigns = {};

                // Найдём кампании по их id
                campaignIds.forEach(campaignId => {
                    const campaign = Array.from(data["Query result"]).find(campaign => campaign.id === parseInt(campaignId));

                    if (campaign) {
                        campaigns[campaignId] = campaign;
                    }
                });

                return campaigns;
            } catch (error) {
                console.error("Произошла ошибка:", error);
                return {};
            }
        }

        

        document.addEventListener('DOMContentLoaded', async function() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('main-list').style.display = 'none';

            // Использование функции для получения user_id
            const userId = getQueryParam('user_id');

            // Проверка наличия user_id
            if (!userId) {
                // Если user_id отсутствует, делаем редирект на login.html
                window.location.href = 'login.html';
            } else {
                console.log('user_id:', userId);
            }

            try {
                const userGuid = await findUserIdByNumber('data/users.json', userId);
                console.log("userGuid:", userGuid);

                const url = `https://seljmov.pythonanywhere.com/predict?user_id=${userGuid}`;
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error('Ошибка загрузки данных: ' + response.statusText);
                }

                const data = await response.json();

                if (data.prediction && Array.isArray(data.prediction)) {
                    const predictionArray = data.prediction;
                    console.log("Получены данные:", predictionArray);

                    const campaigns = await getCampaignsByKeywords('data/keywords.json', predictionArray);
                    console.log("Кампании с ключевыми словами:", campaigns);

                    const result = await findCampaignWithMostKeywords(campaigns);
                    console.log("Кампании с наибольшим количеством ключевых слов:", result);

                    const uniqueCampaignsIds = Array.from(new Set(result.map(campaign => parseInt(campaign.campaign_id))));
                    console.log("Уникальные id кампаний:", uniqueCampaignsIds);

                    const campaignDetails = await getCampaignsDetails('data/campaigns.json', uniqueCampaignsIds);
                    console.log("Детали кампаний:", campaignDetails);

                    const first = uniqueCampaignsIds[0];
                    const other = uniqueCampaignsIds.slice(1);

                    console.log("Главная кампания:", first);
                    console.log("Другие кампании:", other);

                    const mainCampaignCard = generateCampaignCard(campaignDetails[first]);
                    const mainCard = document.querySelector('.campaign-main-card');
                    mainCard.appendChild(mainCampaignCard);

                    if (other.length === 0) {
                        document.getElementById('show-more').style.display = 'none';
                        return;
                    }

                    const campaignsList = document.querySelector('.campaign-sublist');

                    for (const campaign of other) {
                        const campaignCard = generateCampaignCard(campaignDetails[campaign]);
                        campaignsList.appendChild(campaignCard);
                    }
                } else {
                    throw new Error('Некорректный формат данных: отсутствует массив prediction.');
                }
            } catch (error) {
                console.error("Произошла ошибка:", error);
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-list').style.display = 'flex';

            const showMoreButton = document.getElementById('show-more');
            const campaignSublist = document.querySelector('.campaign-sublist');

            showMoreButton.addEventListener('click', function() {
                campaignSublist.classList.add('campaign-sublist--visible');

                showMoreButton.style.display = 'none';
            });
        });
    </script>
</body>
</html>