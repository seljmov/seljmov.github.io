<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сборы</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="wrapper">
        <img src="img/tooba_logo.png" alt="logo" class="logo">
        <div id="loading" style="display: flex; align-items: center; justify-content: center;">
            <span>Загрузка...</span>
        </div>
        <div id="main-list" class="campaigns-list" style="display: none;">
            <div class="campaign-main-card"></div>
            <button id="show-more" class="login-button" style="width: max-content; padding-left: 16px; padding-right: 16px;">
                Показать больше
            </button>
            <div class="campaign-sublist"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/core-js-bundle@3/dist/core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/regenerator-runtime@0.13.11/runtime.js"></script>

    <script src="js/feed.js"></script>
    <script>
        let user_id = undefined;
        function getQueryParam(paramName) {
            const url = new URL(window.location.href);
            const params = new URLSearchParams(url.search);
            return params.get(paramName);
        }        

        document.addEventListener('DOMContentLoaded', async function() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('main-list').style.display = 'none';

            // Использование функции для получения user_id
            const userId = getQueryParam('user_id');

            // Проверка наличия user_id
            if (!userId) {
                // Если user_id отсутствует, делаем редирект на login.html
                window.location.href = 'login.html';
            } else {
                console.log('user_id:', userId);
            }

            try {
                const userGuid = await findUserIdByNumber('data/users.json', userId);
                console.log("userGuid:", userGuid);

                const url = `https://seljmov.pythonanywhere.com/predict?user_id=${userGuid}`;
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error('Ошибка загрузки данных: ' + response.statusText);
                }

                const data = await response.json();

                if (data.prediction && Array.isArray(data.prediction)) {
                    const predictionArray = data.prediction;
                    console.log("Получены данные:", predictionArray);

                    const campaigns = await getCampaignsByKeywords('data/keywords.json', predictionArray);
                    console.log("Кампании с ключевыми словами:", campaigns);

                    const result = await findCampaignWithMostKeywords(campaigns);
                    console.log("Кампании с наибольшим количеством ключевых слов:", result);

                    const uniqueCampaignsIds = Array.from(new Set(result.map(campaign => parseInt(campaign.campaign_id))));
                    console.log("Уникальные id кампаний:", uniqueCampaignsIds);

                    const campaignDetails = await getCampaignsDetails('data/campaigns.json', uniqueCampaignsIds);
                    console.log("Детали кампаний:", campaignDetails);

                    const first = uniqueCampaignsIds[0];
                    const other = uniqueCampaignsIds.slice(1);

                    console.log("Главная кампания:", first);
                    console.log("Другие кампании:", other);

                    const mainCampaignCard = generateCampaignCard(campaignDetails[first]);
                    const mainCard = document.querySelector('.campaign-main-card');
                    mainCard.appendChild(mainCampaignCard);

                    if (other.length === 0) {
                        document.getElementById('show-more').style.display = 'none';
                        return;
                    }

                    const campaignsList = document.querySelector('.campaign-sublist');

                    for (const campaign of other) {
                        const campaignCard = generateCampaignCard(campaignDetails[campaign]);
                        campaignsList.appendChild(campaignCard);
                    }
                } else {
                    throw new Error('Некорректный формат данных: отсутствует массив prediction.');
                }
            } catch (error) {
                console.error("Произошла ошибка:", error);
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-list').style.display = 'flex';

            const showMoreButton = document.getElementById('show-more');
            const campaignSublist = document.querySelector('.campaign-sublist');

            showMoreButton.addEventListener('click', function() {
                campaignSublist.classList.add('campaign-sublist--visible');

                showMoreButton.style.display = 'none';
            });
        });
    </script>
</body>
</html>